<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Launcher 程序的启动 | eaaomk</title>
    <meta name="generator" content="VuePress 1.9.4">
    <link rel="icon" href="/blog/logo.png">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/blog/assets/css/0.styles.5a668c74.css" as="style"><link rel="preload" href="/blog/assets/js/app.19518fa2.js" as="script"><link rel="preload" href="/blog/assets/js/5.4859d6c2.js" as="script"><link rel="preload" href="/blog/assets/js/1.5aece763.js" as="script"><link rel="preload" href="/blog/assets/js/29.c5bba8d3.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.d5bce0ea.js"><link rel="prefetch" href="/blog/assets/js/11.76facc45.js"><link rel="prefetch" href="/blog/assets/js/12.19550e35.js"><link rel="prefetch" href="/blog/assets/js/13.e756f87b.js"><link rel="prefetch" href="/blog/assets/js/14.414d59aa.js"><link rel="prefetch" href="/blog/assets/js/15.6c9f042b.js"><link rel="prefetch" href="/blog/assets/js/16.f5af03e6.js"><link rel="prefetch" href="/blog/assets/js/17.d197dcbc.js"><link rel="prefetch" href="/blog/assets/js/18.4b7b558f.js"><link rel="prefetch" href="/blog/assets/js/19.71d9adeb.js"><link rel="prefetch" href="/blog/assets/js/20.921a7be9.js"><link rel="prefetch" href="/blog/assets/js/21.37c53cfe.js"><link rel="prefetch" href="/blog/assets/js/22.d4568056.js"><link rel="prefetch" href="/blog/assets/js/23.09b308cf.js"><link rel="prefetch" href="/blog/assets/js/24.4b342a99.js"><link rel="prefetch" href="/blog/assets/js/25.b2e72b20.js"><link rel="prefetch" href="/blog/assets/js/26.72d2aecb.js"><link rel="prefetch" href="/blog/assets/js/27.e54d6e48.js"><link rel="prefetch" href="/blog/assets/js/28.ff590f32.js"><link rel="prefetch" href="/blog/assets/js/3.1d8dc234.js"><link rel="prefetch" href="/blog/assets/js/30.06622705.js"><link rel="prefetch" href="/blog/assets/js/31.b562121e.js"><link rel="prefetch" href="/blog/assets/js/32.cdc8fcd2.js"><link rel="prefetch" href="/blog/assets/js/33.0471b68b.js"><link rel="prefetch" href="/blog/assets/js/34.9ce5879e.js"><link rel="prefetch" href="/blog/assets/js/35.6ee0a075.js"><link rel="prefetch" href="/blog/assets/js/36.7ef08d9c.js"><link rel="prefetch" href="/blog/assets/js/37.d15d35c1.js"><link rel="prefetch" href="/blog/assets/js/38.ab712803.js"><link rel="prefetch" href="/blog/assets/js/39.23376734.js"><link rel="prefetch" href="/blog/assets/js/4.3af5333b.js"><link rel="prefetch" href="/blog/assets/js/40.6da53d10.js"><link rel="prefetch" href="/blog/assets/js/41.de685141.js"><link rel="prefetch" href="/blog/assets/js/42.504d2067.js"><link rel="prefetch" href="/blog/assets/js/43.678c8e5c.js"><link rel="prefetch" href="/blog/assets/js/44.b211d311.js"><link rel="prefetch" href="/blog/assets/js/45.fead227f.js"><link rel="prefetch" href="/blog/assets/js/46.aefbe6dd.js"><link rel="prefetch" href="/blog/assets/js/47.a91e528d.js"><link rel="prefetch" href="/blog/assets/js/48.aa058936.js"><link rel="prefetch" href="/blog/assets/js/49.eb882fee.js"><link rel="prefetch" href="/blog/assets/js/6.e1a557a2.js"><link rel="prefetch" href="/blog/assets/js/7.f67b8398.js"><link rel="prefetch" href="/blog/assets/js/8.51a50bb1.js"><link rel="prefetch" href="/blog/assets/js/9.4dccae3e.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.5a668c74.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-007af369><div data-v-007af369><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-007af369 data-v-007af369><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-221076ea data-v-007af369 data-v-007af369><h3 class="title" style="display:none;" data-v-221076ea data-v-221076ea>
      eaaomk
    </h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-221076ea data-v-221076ea><input type="password" value="" data-v-221076ea> <span data-v-221076ea>Konck! Knock!</span> <button data-v-221076ea>OK</button></label></div> <div class="hide" data-v-007af369><div data-v-007af369><div id="smart" class="wrapper-page" style="background-image:url(/blog/back01.jpg);background-position-x:center;background-position-y:center;background-size:cover;background-repeat-x:no-repeat;background-repeat-y:no-repeat;" data-v-007af369><header class="navbar" data-v-007af369><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="eaaomk" class="logo"> <span class="site-name">eaaomk</span></a> <div class="links"><div id="dayNightSwitch" class="generalWrapper" data-v-52d14190><a class="click" data-v-52d14190><div class="onOff daySwitch" data-v-52d14190><div class="star star1" data-v-52d14190></div> <div class="star star2" data-v-52d14190></div> <div class="star star3" data-v-52d14190></div> <div class="star star4" data-v-52d14190></div> <div class="star star5" data-v-52d14190></div> <div class="star sky" data-v-52d14190></div> <div class="sunMoon" data-v-52d14190><div class="crater crater1" data-v-52d14190></div> <div class="crater crater2" data-v-52d14190></div> <div class="crater crater3" data-v-52d14190></div> <div class="cloud part1" data-v-52d14190></div> <div class="cloud part2" data-v-52d14190></div></div></div></a></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/常用命令/" class="nav-link"><i class="iconfont undefined"></i>
  常用命令
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/情景再现/" class="nav-link"><i class="iconfont undefined"></i>
  情景再现
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/AMS/" class="nav-link"><i class="iconfont undefined"></i>
  AMS
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Zygote/" class="nav-link"><i class="iconfont undefined"></i>
  Zygote
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/审计/" class="nav-link"><i class="iconfont undefined"></i>
  审计
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/财务会计/" class="nav-link"><i class="iconfont undefined"></i>
  财务会计
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/进程与线程/" class="nav-link"><i class="iconfont undefined"></i>
  进程与线程
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/消息传递/" class="nav-link"><i class="iconfont undefined"></i>
  消息传递
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/处理机调度与死锁/" class="nav-link"><i class="iconfont undefined"></i>
  处理机调度与死锁
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/设计思想与代码质量优化/" class="nav-link"><i class="iconfont undefined"></i>
  设计思想与代码质量优化
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/设计模式/" class="nav-link"><i class="iconfont undefined"></i>
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/数据结构/" class="nav-link"><i class="iconfont undefined"></i>
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/算法/" class="nav-link"><i class="iconfont undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/VSCODE/" class="nav-link"><i class="iconfont undefined"></i>
  VSCODE
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/blog/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-007af369></div> <aside class="sidebar" data-v-007af369><div class="personal-info-wrapper" data-v-3eba7259 data-v-007af369><img src="/blog/logo.png" alt="author-avatar" class="personal-img" data-v-3eba7259> <h3 class="name" data-v-3eba7259>
    eaaomk
  </h3> <div class="num" data-v-3eba7259><div data-v-3eba7259><h3 data-v-3eba7259>37</h3> <h6 data-v-3eba7259>文章</h6></div> <div data-v-3eba7259><h3 data-v-3eba7259>10</h3> <h6 data-v-3eba7259>标签</h6></div></div> <hr data-v-3eba7259></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/常用命令/" class="nav-link"><i class="iconfont undefined"></i>
  常用命令
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/情景再现/" class="nav-link"><i class="iconfont undefined"></i>
  情景再现
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/AMS/" class="nav-link"><i class="iconfont undefined"></i>
  AMS
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Zygote/" class="nav-link"><i class="iconfont undefined"></i>
  Zygote
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/审计/" class="nav-link"><i class="iconfont undefined"></i>
  审计
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/财务会计/" class="nav-link"><i class="iconfont undefined"></i>
  财务会计
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/进程与线程/" class="nav-link"><i class="iconfont undefined"></i>
  进程与线程
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/消息传递/" class="nav-link"><i class="iconfont undefined"></i>
  消息传递
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/处理机调度与死锁/" class="nav-link"><i class="iconfont undefined"></i>
  处理机调度与死锁
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/设计思想与代码质量优化/" class="nav-link"><i class="iconfont undefined"></i>
  设计思想与代码质量优化
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/设计模式/" class="nav-link"><i class="iconfont undefined"></i>
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/数据结构/" class="nav-link"><i class="iconfont undefined"></i>
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/算法/" class="nav-link"><i class="iconfont undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/VSCODE/" class="nav-link"><i class="iconfont undefined"></i>
  VSCODE
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/blog/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-221076ea data-v-007af369><h3 class="title" style="display:none;" data-v-221076ea data-v-221076ea>
      Launcher 程序的启动
    </h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-221076ea data-v-221076ea><input type="password" value="" data-v-221076ea> <span data-v-221076ea>Konck! Knock!</span> <button data-v-221076ea>OK</button></label></div></div> <div data-v-007af369><main class="page"><div class="page-title" style="display:none;"><h1 class="title">Launcher 程序的启动</h1> <div class="page-info" data-v-709b7add><i class="iconfont reco-account" data-v-709b7add><span data-v-709b7add>eaaomk</span></i> <i class="iconfont reco-date" data-v-709b7add><span data-v-709b7add>2021-12-31 23:00:00</span></i> <!----> <i class="iconfont reco-tag tags" data-v-709b7add><span class="tag-item" data-v-709b7add>Java</span><span class="tag-item" data-v-709b7add>Android</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><h2 id="launcher-程序的启动"><a href="#launcher-程序的启动" class="header-anchor">#</a> Launcher 程序的启动</h2> <p>在认识AMS对Activity的管理与调度之前，建议先认识一下Launcher 程序的启动。
Launcher程序就是我们的桌面程序，桌面程序是一直运行的，那如果用户结束了这个桌面程序，那就没桌面可返回了，那显然是不会的。
那么系统启动这第一个App程序是在哪里呢？请往下接着看源码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/services/java/com/android/server/SystemServer.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">TimingsTraceAndSlog</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mActivityManagerService<span class="token punctuation">.</span><span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Making services ready&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">&quot;StartActivityManagerReadyPhase&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startBootPhase</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token class-name">SystemService</span><span class="token punctuation">.</span>PHASE_ACTIVITY_MANAGER_READY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 开启Crash监控</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mActivityManagerService<span class="token punctuation">.</span><span class="token function">startObservingNativeCrashes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reportWtf</span><span class="token punctuation">(</span><span class="token string">&quot;observing native crashes&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// PMS扫描所有包信息</span>
        mPackageManagerService<span class="token punctuation">.</span><span class="token function">waitForAppDataPrepared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startBootPhase</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token class-name">SystemService</span><span class="token punctuation">.</span>PHASE_THIRD_PARTY_APPS_CAN_START<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>开启了必要的服务后，再执行AMS中systemReady的后面一部分代码，传递进去的这个Runnable实际上就是一个前提处理，systemReady方法会先执行这部分代码，再执行后面的一系列流程启动Launcher App.接着往下准备桌面也就是主页的一些信息。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    t<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">&quot;startPersistentApps&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">startPersistentApps</span><span class="token punctuation">(</span><span class="token class-name">PackageManager</span><span class="token punctuation">.</span>MATCH_DIRECT_BOOT_AWARE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    t<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mBooting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">//为系统用户启用主页活动，以便系统始终启动。当系统用户未设置时，我们不会这样做，因为在这种情况下，设置rd应该是处理家庭活动的rd</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UserManager</span><span class="token punctuation">.</span><span class="token function">isSplitSystemUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token class-name">Settings<span class="token punctuation">.</span>Secure</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">Settings<span class="token punctuation">.</span>Secure</span><span class="token punctuation">.</span>USER_SETUP_COMPLETE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
            <span class="token operator">||</span> <span class="token class-name">SystemProperties</span><span class="token punctuation">.</span>getBooleanTEM_USER_HOME_NEEDED<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">&quot;enableHomeActivity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ComponentName</span> cName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> emUserHomeActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">AppGlobals</span><span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">omponentEnabledSetting</span><span class="token punctuation">(</span>cName<span class="token punctuation">,</span>
                    <span class="token class-name">PackageManager</span><span class="token punctuation">.</span>ONENT_ENABLED_STATE_ENABLED<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token class-name">UserHandle</span><span class="token punctuation">.</span>USER_SYSTEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowAsRuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        t<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>bootingSystemUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 开始启动桌面App</span>
        mAtmInternal<span class="token punctuation">.</span><span class="token function">startHomeOnAllDisplays</span><span class="token punctuation">(</span>currentUserId<span class="token punctuation">,</span> <span class="token string">&quot;stemReady&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>调用mAtmInternal启动app，实际上它的实现就是ATMS，最终调用的还是ATMS中的方法，那么下方的代码中出现了熟悉的身影 <em><font color="#0099ff">mRootWindowContainer</font></em> ,如果对这个不了解的读者，请移步阅读 <em><font color="#0099ff">Activity任务栈</font></em> ，这里继续向下调用mRootWindowContainer的startHomeOnAllDisplays方法。</li> <li>可能读者比较好奇，这些数据是什么时候初始化的呢？别忘了之前一系列的ready工作，它的内部就是在做这些准备。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">startHomeOnAllDisplays</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mGlobalLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mRootWindowContainer<span class="token punctuation">.</span><span class="token function">startHomeOnAllDisplays</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>定义homeStarted 作为启动结果的存储，getChildAt函数是在获取DisplayContent的id。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/services/core/java/com/android/server/wm/RootWindowContainer.java</span>
<span class="token keyword">boolean</span> <span class="token function">startHomeOnAllDisplays</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> homeStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> displayId <span class="token operator">=</span> <span class="token function">getChildAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>mDisplayId<span class="token punctuation">;</span>
        <span class="token comment">// 获取一个displayId，继续向下调用</span>
        homeStarted <span class="token operator">|=</span> <span class="token function">startHomeOnDisplay</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> homeStarted<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">boolean</span> <span class="token function">startHomeOnDisplay</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">startHomeOnDisplay</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> displayId<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* allowInstrumenting */</span><span class="token punctuation">,</span>
                <span class="token boolean">false</span> <span class="token comment">/* fromHomeKey */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">boolean</span> <span class="token function">startHomeOnDisplay</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">,</span> <span class="token keyword">int</span> displayId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowInstrumenting<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> fromHomeKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取最上层的有焦点的display,或者默认的display（如果传入的这个displayId是无效的）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>displayId <span class="token operator">==</span> INVALID_DISPLAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> stack <span class="token operator">=</span> <span class="token function">getTopDisplayFocusedStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        displayId <span class="token operator">=</span> stack <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> stack<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> DEFAULT_DISPLAY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 根据id取得DisplayContent</span>
    <span class="token keyword">final</span> <span class="token class-name">DisplayContent</span> display <span class="token operator">=</span> <span class="token function">getDisplayContent</span><span class="token punctuation">(</span>displayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> tcNdx <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getTaskDisplayAreaCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> tcNdx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>tcNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从DisplayAreaPolicy中取出一个TaskDisplayArea</span>
        <span class="token keyword">final</span> <span class="token class-name">TaskDisplayArea</span> taskDisplayArea <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getTaskDisplayAreaAt</span><span class="token punctuation">(</span>tcNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">|=</span> <span class="token function">startHomeOnTaskDisplayArea</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> taskDisplayArea<span class="token punctuation">,</span>
                allowInstrumenting<span class="token punctuation">,</span> fromHomeKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 最终执行到了这里</span>
<span class="token keyword">boolean</span> <span class="token function">startHomeOnTaskDisplayArea</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">,</span> <span class="token class-name">TaskDisplayArea</span> taskDisplayArea<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> allowInstrumenting<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fromHomeKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 做非空判断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>taskDisplayArea <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> stack <span class="token operator">=</span> <span class="token function">getTopDisplayFocusedStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskDisplayArea <span class="token operator">=</span> stack <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> stack<span class="token punctuation">.</span><span class="token function">getDisplayArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">:</span> <span class="token function">getDefaultTaskDisplayArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token class-name">Intent</span> homeIntent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">ActivityInfo</span> aInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 找到这个对应的HomeActivity的信息，做一些准备</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>taskDisplayArea <span class="token operator">==</span> <span class="token function">getDefaultTaskDisplayArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        homeIntent <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getHomeIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        aInfo <span class="token operator">=</span> <span class="token function">resolveHomeActivity</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> homeIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldPlaceSecondaryHomeOnDisplayArea</span><span class="token punctuation">(</span>taskDisplayArea<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivityInfo</span><span class="token punctuation">,</span> <span class="token class-name">Intent</span><span class="token punctuation">&gt;</span></span> info <span class="token operator">=</span> <span class="token function">resolveSecondaryHomeActivity</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> taskDisplayArea<span class="token punctuation">)</span><span class="token punctuation">;</span>
        aInfo <span class="token operator">=</span> info<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
        homeIntent <span class="token operator">=</span> info<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> myReason <span class="token operator">=</span> reason <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>
            aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> taskDisplayArea<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调用ATMS 中的 ActivityStartController 开始启动HomeActivity</span>
    mService<span class="token punctuation">.</span><span class="token function">getActivityStartController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startHomeActivity</span><span class="token punctuation">(</span>homeIntent<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> myReason<span class="token punctuation">,</span>
            taskDisplayArea<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/services/core/java/com/android/server/wm/ActivityStartController.java</span>
<span class="token keyword">void</span> <span class="token function">startHomeActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">ActivityInfo</span> aInfo<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">,</span>
            <span class="token class-name">TaskDisplayArea</span> taskDisplayArea<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> homeStack<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 确保有一个ActivityStack 存在于taskDisplayArea中</span>
            homeStack <span class="token operator">=</span> taskDisplayArea<span class="token punctuation">.</span><span class="token function">getOrCreateRootHomeTask</span><span class="token punctuation">(</span>ON_TOP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            mSupervisor<span class="token punctuation">.</span><span class="token function">endDeferResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取一个Starter 处理事件，最终执行是在execute() 方法中;</span>
        mLastHomeActivityStartResult <span class="token operator">=</span> <span class="token function">obtainStarter</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token string">&quot;startHomeActivity: &quot;</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setOutActivity</span><span class="token punctuation">(</span>tmpOutRecord<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCallingUid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setActivityInfo</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setActivityOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">toBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre></div><ul><li>接下来的流程就与我们平时启动一个普通Activity一样。</li></ul> <h2 id="普通activity的启动流程"><a href="#普通activity的启动流程" class="header-anchor">#</a> 普通Activity的启动流程</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityStarter.java</span>
<span class="token keyword">int</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mGlobalLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">//处理这个请求</span>
            res <span class="token operator">=</span> <span class="token function">executeRequest</span><span class="token punctuation">(</span>mRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
        <span class="token function">onExecutionComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">executeRequest</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 向下调用</span>
    mLastStartActivityResult <span class="token operator">=</span> <span class="token function">startActivityUnchecked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span>
            request<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* doResume */</span><span class="token punctuation">,</span> checkedOptions<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span>
            restrictedBgActivity<span class="token punctuation">,</span> intentGrants<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">startActivityUnchecked</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> sourceRecord<span class="token punctuation">,</span>
                <span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
                <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">,</span> <span class="token class-name">Task</span> inTask<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> restrictedBgActivity<span class="token punctuation">,</span> <span class="token class-name">NeededUriGrants</span> intentGrants<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> START_CANCELED<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> startedActivityStack<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 继续在这里向下调用</span>
        result <span class="token operator">=</span> <span class="token function">startActivityInner</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span>
                startFlags<span class="token punctuation">,</span> doResume<span class="token punctuation">,</span> options<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> restrictedBgActivity<span class="token punctuation">,</span> ntGrants<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token function">postStartActivityProcessing</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> result<span class="token punctuation">,</span> startedActivityStack<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">startActivityInner</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> sourceRecord<span class="token punctuation">,</span>
              <span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
              <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">,</span> <span class="token class-name">Task</span> inTask<span class="token punctuation">,</span>
              <span class="token keyword">boolean</span> restrictedBgActivity<span class="token punctuation">,</span> <span class="token class-name">NeededUriGrants</span> intentGrants<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">setInitialState</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> options<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> doResume<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> eSession<span class="token punctuation">,</span>
                  voiceInteractor<span class="token punctuation">,</span> restrictedBgActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token function">computeLaunchingTaskFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">computeSourceStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算让哪一个ActivityStack去启动这个Activity</span>

    mIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>mLaunchFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> newTask <span class="token operator">=</span> targetTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    mTargetTask <span class="token operator">=</span> targetTask<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果它是一个新的Task,则将其放入,注意我们这里加入的是一个ActivityTask(ActivityTask继承至Task类)</span>
        <span class="token keyword">final</span> <span class="token class-name">Task</span> taskToAffiliate <span class="token operator">=</span> <span class="token punctuation">(</span>mLaunchTaskBehind <span class="token operator">&amp;&amp;</span> mSourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token operator">?</span> mSourceRecord<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token function">setNewTask</span><span class="token punctuation">(</span>taskToAffiliate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mAddingToTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 或者需要加入Task</span>
        <span class="token function">addOrReparentStartingActivity</span><span class="token punctuation">(</span>targetTask<span class="token punctuation">,</span> <span class="token string">&quot;adding to task&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mDoResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> topTaskActivity <span class="token operator">=</span>
                mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mTargetStack<span class="token punctuation">.</span><span class="token function">isTopActivityFocusable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token punctuation">(</span>topTaskActivity <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> topTaskActivity<span class="token punctuation">.</span><span class="token function">isTaskOverlay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> mStartActivity <span class="token operator">!=</span> topTaskActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">/// 执行启动Activity的流程</span>
            mRootWindowContainer<span class="token punctuation">.</span><span class="token function">resumeFocusedStacksTopActivities</span><span class="token punctuation">(</span>
                    mTargetStack<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">,</span> mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 更新栈</span>
    mRootWindowContainer<span class="token punctuation">.</span><span class="token function">updateUserStack</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>mUserId<span class="token punctuation">,</span> mTargetStack<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update the recent tasks list immediately when the activity starts</span>
    <span class="token comment">// 放入mRecentTasks中</span>
    mSupervisor<span class="token punctuation">.</span>mRecentTasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSupervisor<span class="token punctuation">.</span><span class="token function">handleNonResizableTaskIfNeeded</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            mPreferredWindowingMode<span class="token punctuation">,</span> mPreferredTaskDisplayArea<span class="token punctuation">,</span> mTargetStack<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> START_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/services/core/java/com/android/server/wm/RootWindowContainer.java</span>
<span class="token keyword">boolean</span> <span class="token function">resumeFocusedStacksTopActivities</span><span class="token punctuation">(</span>
    <span class="token class-name">ActivityStack</span> targetStack<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> target<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> targetOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> <span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> displayNdx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> resumedOnDisplay <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">DisplayContent</span> display <span class="token operator">=</span> <span class="token function">getChildAt</span><span class="token punctuation">(</span>displayNdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resumedOnDisplay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">ActivityStack</span> focusedStack <span class="token operator">=</span> display<span class="token punctuation">.</span><span class="token function">getFocusedStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>focusedStack <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 不为空,则调用resumeTopActivityUncheckedLocked函数</span>
                result <span class="token operator">|=</span> focusedStack<span class="token punctuation">.</span><span class="token function">resumeTopActivityUncheckedLocked</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> targetOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>targetStack <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果目标栈为空，则返回桌面应用程序</span>
                result <span class="token operator">|=</span> <span class="token function">resumeHomeActivity</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/* prev */</span><span class="token punctuation">,</span> <span class="token string">&quot;no-focusable-task&quot;</span><span class="token punctuation">,</span>
                        display<span class="token punctuation">.</span><span class="token function">getDefaultTaskDisplayArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/services/core/java/com/android/server/wm/ActivityStack.java</span>
<span class="token keyword">boolean</span> <span class="token function">resumeTopActivityUncheckedLocked</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> prev<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mInResumeTopActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Don't even start recursing.</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//使用之前计算出来的栈进行启动Activity</span>
        result <span class="token operator">=</span> <span class="token function">resumeTopActivityInnerLocked</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        mInResumeTopActivity <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">resumeTopActivityInnerLocked</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> prev<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAtmService<span class="token punctuation">.</span><span class="token function">isBooting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mAtmService<span class="token punctuation">.</span><span class="token function">isBooted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Not ready yet!</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">boolean</span> pausing <span class="token operator">=</span> taskDisplayArea<span class="token punctuation">.</span><span class="token function">pauseBackStacks</span><span class="token punctuation">(</span>userLeaving<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mResumedActivity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STATES<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span>
                <span class="token string">&quot;resumeTopActivityLocked: Pausing &quot;</span> <span class="token operator">+</span> mResumedActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 通知Launcher进入Pause状态，在它进入这个状态后，在ActivityStackSupervisor的startSpecificActivity方法里判断新的app进程状态做出不同响应</span>
        pausing <span class="token operator">|=</span> <span class="token function">startPausingLocked</span><span class="token punctuation">(</span>userLeaving<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* uiSleeping */</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">attachedToProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_STATES<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG_STATES<span class="token punctuation">,</span> <span class="token string">&quot;resumeTopActivityLocked: Restarting &quot;</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用ActivityStackSupervisor启动Activity</span>
        mStackSupervisor<span class="token punctuation">.</span><span class="token function">startSpecificActivity</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>判断该应用的进程是否存在，这里会出现一个分支分为两个方向，如果进程不存在（一般情况下，创建这个应用程序的第一个Activity会创建一个新的进程），那么将会创建一个新的进程，下文将会</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityStackSupervisor.java</span>
<span class="token keyword">void</span> <span class="token function">startSpecificActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> andResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Is this activity's application already running?</span>
    <span class="token comment">// 获取应用的进程信息</span>
    <span class="token keyword">final</span> <span class="token class-name">WindowProcessController</span> wpc <span class="token operator">=</span>
            mService<span class="token punctuation">.</span><span class="token function">getProcessController</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> knownToBeDead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wpc <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> wpc<span class="token punctuation">.</span><span class="token function">hasThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//如果进程存在，并且进程中有线程存在，就启动一个同应用的activity</span>
            <span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> wpc<span class="token punctuation">,</span> andResume<span class="token punctuation">,</span> checkConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 这里直接返回</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Exception when starting activity &quot;</span>
                    <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If a dead object exception was thrown -- fall through to</span>
        <span class="token comment">// restart the application.</span>
        knownToBeDead <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    r<span class="token punctuation">.</span><span class="token function">notifyUnknownVisibilityLaunchedForKeyguardTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTop <span class="token operator">=</span> andResume <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span><span class="token function">isTopRunningActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果上面没有返回，就代表进程不存在，则需要通过AMS向Zygote进程请求创建新进程</span>
    mService<span class="token punctuation">.</span><span class="token function">startProcessAsync</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span> isTop<span class="token punctuation">,</span> isTop <span class="token operator">?</span> <span class="token string">&quot;top-activity&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;activity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="创建新进程"><a href="#创建新进程" class="header-anchor">#</a> 创建新进程</h2> <ul><li>这里的mH 中的Looper 是AMS在初始化中调用了ATMS的initialize函数，它来自于  DisplayThread.get().getLooper() ||DisplayThread它是一个单例,DisplayThread又是在SystemServer中调用了 Looper.prepareMainLooper()，进行了looper的初始化，所以这里发送消息，相当于将时间交给了SystemServer线程处理，最后调用ActivityManagerInternal的startProcess方法，但是ActivityManagerInternal是一个抽象类，它最终的实现是AMS中的LocalService。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</span>
<span class="token keyword">void</span> <span class="token function">startProcessAsync</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> activity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isTop<span class="token punctuation">,</span>
        <span class="token class-name">String</span> hostingType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span>TRACE_TAG_WINDOW_MANAGER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_WINDOW_MANAGER<span class="token punctuation">,</span> <span class="token string">&quot;dispatchingStartProcess:&quot;</span>
                    <span class="token operator">+</span> activity<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Post message to start process to avoid possible deadlock of calling into AMS with the</span>
        <span class="token comment">// ATMS lock held.</span>
        <span class="token comment">// 这里采取的是通过Handler方式发送消息，实现线程的切换</span>
        <span class="token comment">// 如果读者对Handler不能理解，请查阅Handler部分的解读</span>
        <span class="token keyword">final</span> <span class="token class-name">Message</span> m <span class="token operator">=</span> <span class="token class-name">PooledLambda</span><span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span><span class="token class-name">ActivityManagerInternal</span><span class="token operator">::</span><span class="token function">startProcess</span><span class="token punctuation">,</span>
                mAmInternal<span class="token punctuation">,</span> activity<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> activity<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span>
                isTop<span class="token punctuation">,</span> hostingType<span class="token punctuation">,</span> activity<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送消息</span>
        mH<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_WINDOW_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java //LocalService Class</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startProcess</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span> <span class="token class-name">ApplicationInfo</span> info<span class="token punctuation">,</span> <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span>
                            <span class="token keyword">boolean</span> isTop<span class="token punctuation">,</span> <span class="token class-name">String</span> hostingType<span class="token punctuation">,</span> <span class="token class-name">ComponentName</span> hostingName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">,</span> <span class="token string">&quot;startProcess:&quot;</span>
                    <span class="token operator">+</span> processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 开启进程</span>
            <span class="token function">startProcessLocked</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> info<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* intentFlags */</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">HostingRecord</span><span class="token punctuation">(</span>hostingType<span class="token punctuation">,</span> hostingName<span class="token punctuation">,</span> isTop<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* allowWhileBooting */</span><span class="token punctuation">,</span>
                    <span class="token boolean">false</span> <span class="token comment">/* isolated */</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* keepIfLarge */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span>
<span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">final</span> <span class="token class-name">ProcessRecord</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span><span class="token class-name">ApplicationInfo</span> info<span class="token punctuation">,</span> 
    <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span> <span class="token keyword">int</span> intentFlags<span class="token punctuation">,</span><span class="token class-name">HostingRecord</span> hostingRecord<span class="token punctuation">,</span> 
    <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowWhileBooting<span class="token punctuation">,</span><span class="token keyword">boolean</span> isolated<span class="token punctuation">,</span> <span class="token keyword">boolean</span> keepIfLarge<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> mProcessList<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> info<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span> intentFlags<span class="token punctuation">,</span>
            hostingRecord<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span> allowWhileBooting<span class="token punctuation">,</span> isolated<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* isolatedUid */</span><span class="token punctuation">,</span>
            keepIfLarge<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* ABI override */</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* entryPoint */</span><span class="token punctuation">,</span>
            <span class="token keyword">null</span> <span class="token comment">/* entryPointArgs */</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* crashHandler */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/services/core/java/com/android/server/am/ProcessList.java</span>
<span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;mService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">final</span> <span class="token class-name">ProcessRecord</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span> <span class="token class-name">ApplicationInfo</span> info<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span> <span class="token keyword">int</span> intentFlags<span class="token punctuation">,</span> <span class="token class-name">HostingRecord</span> hostingRecord<span class="token punctuation">,</span>
        <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowWhileBooting<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isolated<span class="token punctuation">,</span> <span class="token keyword">int</span> isolatedUid<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> keepIfLarge<span class="token punctuation">,</span> <span class="token class-name">String</span> abiOverride<span class="token punctuation">,</span> <span class="token class-name">String</span> entryPoint<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> entryPointArgs<span class="token punctuation">,</span>
        <span class="token class-name">Runnable</span> crashHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ProcessRecord</span> app<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">//这里省去的代码是检查存在可复用的进程</span>
  
    <span class="token comment">///创建ProcessRecord对象，它保存了当前正在运行的特定进程的完整信息，也就是需要启动的应用程序进程，接着继续调用startProcessLocked方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkSlow</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">&quot;startProcess: creating new process record&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app <span class="token operator">=</span> <span class="token function">newProcessRecordLocked</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> processName<span class="token punctuation">,</span> isolated<span class="token punctuation">,</span> isolatedUid<span class="token punctuation">,</span> hostingRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">checkSlow</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">&quot;startProcess: done creating new process record&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// If this is a new package in the process, add the package to the list</span>
        app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> info<span class="token punctuation">.</span>longVersionCode<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkSlow</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">&quot;startProcess: added package to existing proc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 这里继续向下调用</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> success <span class="token operator">=</span>
            <span class="token function">startProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> hostingRecord<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span> abiOverride<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkSlow</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">&quot;startProcess: done starting proc!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> success <span class="token operator">?</span> app <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

 <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;mService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">boolean</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span><span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span> <span class="token class-name">HostingRecord</span> hostingRecord<span class="token punctuation">,</span>
        <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> disableHiddenApiChecks<span class="token punctuation">,</span> <span class="token keyword">boolean</span> disableTestApiChecks<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> mountExtStorageFull<span class="token punctuation">,</span> <span class="token class-name">String</span> abiOverride<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token comment">// 继续向下调用</span>
        <span class="token keyword">boolean</span> startSuccess <span class="token operator">=</span>  <span class="token function">startProcessLocked</span><span class="token punctuation">(</span>hostingRecord<span class="token punctuation">,</span> entryPoint<span class="token punctuation">,</span>
                    app<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span> runtimeFlags<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span> requiredAbi<span class="token punctuation">,</span>
                    instructionSet<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mService<span class="token punctuation">.</span><span class="token function">forceStopPackageLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token string">&quot;start failure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;mService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">boolean</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span><span class="token class-name">HostingRecord</span> hostingRecord<span class="token punctuation">,</span> <span class="token class-name">String</span> entryPoint<span class="token punctuation">,</span> <span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span>
        <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span> <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span>
        <span class="token class-name">String</span> seInfo<span class="token punctuation">,</span> <span class="token class-name">String</span> requiredAbi<span class="token punctuation">,</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span> <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span>
        <span class="token keyword">long</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mConstants<span class="token punctuation">.</span>FLAG_PROCESS_START_ASYNC<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 继续调用startProcess方法</span>
            <span class="token keyword">final</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> startResult <span class="token operator">=</span> <span class="token function">startProcess</span><span class="token punctuation">(</span>hostingRecord<span class="token punctuation">,</span>
                    entryPoint<span class="token punctuation">,</span> app<span class="token punctuation">,</span>
                    uid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span> runtimeFlags<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span>
                    requiredAbi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mService<span class="token punctuation">.</span><span class="token function">forceStopPackageLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token string">&quot;start failure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> app<span class="token punctuation">.</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> <span class="token function">startProcess</span><span class="token punctuation">(</span><span class="token class-name">HostingRecord</span> hostingRecord<span class="token punctuation">,</span> <span class="token class-name">String</span> entryPoint<span class="token punctuation">,</span>
            <span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span> <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span>
            <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span> <span class="token class-name">String</span> seInfo<span class="token punctuation">,</span> <span class="token class-name">String</span> requiredAbi<span class="token punctuation">,</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span>
            <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span> <span class="token keyword">long</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> startResult<span class="token punctuation">;</span>
        <span class="token comment">// 根据启动的不同类型的App，有不同的创建进程的方式</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hostingRecord<span class="token punctuation">.</span><span class="token function">usesWebviewZygote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//启动webview进程</span>
            startResult <span class="token operator">=</span> <span class="token function">startWebView</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span> runtimeFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span> requiredAbi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>dataDir<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> app<span class="token punctuation">.</span>mDisabledCompatChanges<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>PROC_START_SEQ_IDENT <span class="token operator">+</span> app<span class="token punctuation">.</span>startSeq<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hostingRecord<span class="token punctuation">.</span><span class="token function">usesAppZygote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 处理用户AppZygote</span>
            <span class="token keyword">final</span> <span class="token class-name">AppZygote</span> appZygote <span class="token operator">=</span> <span class="token function">createAppZygoteForProcessIfNeeded</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// We can't isolate app data and storage data as parent zygote already did that.</span>
            startResult <span class="token operator">=</span> appZygote<span class="token punctuation">.</span><span class="token function">getProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span> runtimeFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span> requiredAbi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>dataDir<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                    <span class="token comment">/*zygotePolicyFlags=*/</span> ZYGOTE_POLICY_FLAG_EMPTY<span class="token punctuation">,</span> isTopApp<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>mDisabledCompatChanges<span class="token punctuation">,</span> pkgDataInfoMap<span class="token punctuation">,</span> whitelistedAppDataInfoMap<span class="token punctuation">,</span>
                    <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>PROC_START_SEQ_IDENT <span class="token operator">+</span> app<span class="token punctuation">.</span>startSeq<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//新创建的应用程序进程 </span>
            <span class="token comment">//modify for prefork blank process begin</span>
            <span class="token class-name">PreForkArgs</span> preforkArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PreForkArgs</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span> runtimeFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span> requiredAbi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>dataDir<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span>
                    isTopApp<span class="token punctuation">,</span> app<span class="token punctuation">.</span>mDisabledCompatChanges<span class="token punctuation">,</span> pkgDataInfoMap<span class="token punctuation">,</span>
                    whitelistedAppDataInfoMap<span class="token punctuation">,</span> bindMountAppsData<span class="token punctuation">,</span> bindMountAppStorageDirs<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>PROC_START_SEQ_IDENT <span class="token operator">+</span> app<span class="token punctuation">.</span>startSeq<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            startResult <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">handlePreForkStartProcess</span><span class="token punctuation">(</span>preforkArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>startResult <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 调用了Process 的 start方法 开启新进程</span>
                startResult <span class="token operator">=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">,</span>
                        app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span> runtimeFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span>
                        app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span> requiredAbi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span>
                        app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>dataDir<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span>
                        isTopApp<span class="token punctuation">,</span> app<span class="token punctuation">.</span>mDisabledCompatChanges<span class="token punctuation">,</span> pkgDataInfoMap<span class="token punctuation">,</span>
                        whitelistedAppDataInfoMap<span class="token punctuation">,</span> bindMountAppsData<span class="token punctuation">,</span> bindMountAppStorageDirs<span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>PROC_START_SEQ_IDENT <span class="token operator">+</span> app<span class="token punctuation">.</span>startSeq<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">//modify for prefork blank process end</span>
        <span class="token punctuation">}</span>
        <span class="token function">checkSlow</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> <span class="token string">&quot;startProcess: returned from zygote!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> startResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="向zygote申请创建进程"><a href="#向zygote申请创建进程" class="header-anchor">#</a> 向Zygote申请创建进程</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/core/java/android/os/Process.java</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ProcessStartResult</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> <span class="token class-name">String</span> processClass<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">String</span> niceName<span class="token punctuation">,</span>
                                           <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> gid<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span>
                                           <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span>
                                           <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span>
                                           <span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> seInfo<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> abi<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> appDataDir<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> packageName<span class="token punctuation">,</span>
                                           <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span>
                                           <span class="token keyword">boolean</span> isTopApp<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                   pkgDataInfoMap<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                   whitelistedDataInfoMap<span class="token punctuation">,</span>
                                           <span class="token keyword">boolean</span> bindMountAppsData<span class="token punctuation">,</span>
                                           <span class="token keyword">boolean</span> bindMountAppStorageDirs<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> zygoteArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 向zygote 进程发送开启新进程的请求</span>
    <span class="token keyword">return</span> ZYGOTE_PROCESS<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>processClass<span class="token punctuation">,</span> niceName<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span>
                runtimeFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span> targetSdkVersion<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span>
                abi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span> appDataDir<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> packageName<span class="token punctuation">,</span>
                zygotePolicyFlags<span class="token punctuation">,</span> isTopApp<span class="token punctuation">,</span> disabledCompatChanges<span class="token punctuation">,</span>
                pkgDataInfoMap<span class="token punctuation">,</span> whitelistedDataInfoMap<span class="token punctuation">,</span> bindMountAppsData<span class="token punctuation">,</span>
                bindMountAppStorageDirs<span class="token punctuation">,</span> zygoteArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/core/java/android/os/ZygoteProcess.java</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> <span class="token class-name">String</span> processClass<span class="token punctuation">,</span>
                                                <span class="token keyword">final</span> <span class="token class-name">String</span> niceName<span class="token punctuation">,</span>
                                                <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> gid<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span>
                                                <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span>
                                                <span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> seInfo<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> abi<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> appDataDir<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> packageName<span class="token punctuation">,</span>
                                                <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span>
                                                <span class="token keyword">boolean</span> isTopApp<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                        pkgDataInfoMap<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                        whitelistedDataInfoMap<span class="token punctuation">,</span>
                                                <span class="token keyword">boolean</span> bindMountAppsData<span class="token punctuation">,</span>
                                                <span class="token keyword">boolean</span> bindMountAppStorageDirs<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> zygoteArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO (chriswailes): Is there a better place to check this value?</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fetchUsapPoolEnabledPropWithMinInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">informZygotesOfUsapPoolStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 向下继续执行</span>
        <span class="token keyword">return</span> <span class="token function">startViaZygote</span><span class="token punctuation">(</span>processClass<span class="token punctuation">,</span> niceName<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span>
                runtimeFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span> targetSdkVersion<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span>
                abi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span> appDataDir<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> <span class="token comment">/*startChildZygote=*/</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                packageName<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span> isTopApp<span class="token punctuation">,</span> disabledCompatChanges<span class="token punctuation">,</span>
                pkgDataInfoMap<span class="token punctuation">,</span> whitelistedDataInfoMap<span class="token punctuation">,</span> bindMountAppsData<span class="token punctuation">,</span>
                bindMountAppStorageDirs<span class="token punctuation">,</span> zygoteArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ZygoteStartFailedEx</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span>
                <span class="token string">&quot;Starting VM process through Zygote failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Starting VM process through Zygote failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">private</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> <span class="token function">startViaZygote</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> <span class="token class-name">String</span> processClass<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">String</span> niceName<span class="token punctuation">,</span>
                                                    <span class="token keyword">final</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> gid<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span>
                                                    <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span>
                                                    <span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> seInfo<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> abi<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> appDataDir<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span>
                                                    <span class="token keyword">boolean</span> startChildZygote<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> packageName<span class="token punctuation">,</span>
                                                    <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span>
                                                    <span class="token keyword">boolean</span> isTopApp<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                            pkgDataInfoMap<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                            whitelistedDataInfoMap<span class="token punctuation">,</span>
                                                    <span class="token keyword">boolean</span> bindMountAppsData<span class="token punctuation">,</span>
                                                    <span class="token keyword">boolean</span> bindMountAppStorageDirs<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> extraArgs<span class="token punctuation">)</span>
                                                    <span class="token keyword">throws</span> <span class="token class-name">ZygoteStartFailedEx</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> argsForZygote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// --runtime-args, --setuid=, --setgid=,</span>
    <span class="token comment">// and --setgroups= must go first</span>
    argsForZygote<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;--runtime-args&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    argsForZygote<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;--setuid=&quot;</span> <span class="token operator">+</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    argsForZygote<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;--setgid=&quot;</span> <span class="token operator">+</span> gid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    argsForZygote<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;--runtime-flags=&quot;</span> <span class="token operator">+</span> runtimeFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 构造了一堆进程信息</span>

    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// The USAP pool can not be used if the application will not use the systems graphics</span>
        <span class="token comment">// driver.  If that driver is requested use the Zygote application start path.</span>
        <span class="token comment">// openZygoteSocketIfNeeded 是在打开一个连接口使用</span>
        <span class="token keyword">return</span> <span class="token function">zygoteSendArgsAndGetResult</span><span class="token punctuation">(</span><span class="token function">openZygoteSocketIfNeeded</span><span class="token punctuation">(</span>abi<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                            zygotePolicyFlags<span class="token punctuation">,</span>
                                            argsForZygote<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;mLock&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> <span class="token function">zygoteSendArgsAndGetResult</span><span class="token punctuation">(</span>
        <span class="token class-name">ZygoteState</span> zygoteState<span class="token punctuation">,</span> <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">ZygoteStartFailedEx</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldAttemptUsapLaunch</span><span class="token punctuation">(</span>zygotePolicyFlags<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">attemptUsapSendArgsAndGetResult</span><span class="token punctuation">(</span>zygoteState<span class="token punctuation">,</span> msgStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If there was an IOException using the USAP pool we will log the error and</span>
            <span class="token comment">// attempt to start the process through the Zygote.</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span> <span class="token string">&quot;IO Exception while communicating with USAP pool - &quot;</span>
                    <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">attemptZygoteSendArgsAndGetResult</span><span class="token punctuation">(</span>zygoteState<span class="token punctuation">,</span> msgStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> <span class="token function">attemptZygoteSendArgsAndGetResult</span><span class="token punctuation">(</span>
        <span class="token class-name">ZygoteState</span> zygoteState<span class="token punctuation">,</span> <span class="token class-name">String</span> msgStr<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZygoteStartFailedEx</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">/// 获取一个BufferedWriter 通过socket 通信向 zygote 进程发送创建进程的信息</span>
        <span class="token comment">// 获取一个 DataInputStream 通过socket 通信 读取zygote创建进程的结果</span>
        <span class="token keyword">final</span> <span class="token class-name">BufferedWriter</span> zygoteWriter <span class="token operator">=</span> zygoteState<span class="token punctuation">.</span>mZygoteOutputWriter<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">DataInputStream</span> zygoteInputStream <span class="token operator">=</span> zygoteState<span class="token punctuation">.</span>mZygoteInputStream<span class="token punctuation">;</span>

        zygoteWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msgStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        zygoteWriter<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>pid <span class="token operator">=</span> zygoteInputStream<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>usingWrapper <span class="token operator">=</span> zygoteInputStream<span class="token punctuation">.</span><span class="token function">readBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteStartFailedEx</span><span class="token punctuation">(</span><span class="token string">&quot;fork() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        zygoteState<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span> <span class="token string">&quot;IO Exception while communicating with Zygote - &quot;</span>
                <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteStartFailedEx</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="zygote创建进程"><a href="#zygote创建进程" class="header-anchor">#</a> Zygote创建进程</h2> <ul><li>如果读者对Zygote进程启动之前的流程不熟悉，请移步阅读Android系统的启动流程。</li> <li>这里将会探讨Zygote的进程启动后都做了些什么，是framework层面的，并非C/C++(native)层次.</li> <li>如果读者对fork函数存在疑问请移步阅读fork相关文章</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ZygoteServer</span> zygoteServer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// Mark zygote start. This ensures that thread creation will throw</span>
    <span class="token comment">// an error.</span>
    <span class="token class-name">ZygoteHooks</span><span class="token punctuation">.</span><span class="token function">startZygoteNoThreadCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Zygote goes into its own process group.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Os</span><span class="token punctuation">.</span><span class="token function">setpgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to setpgid(0,0)&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Runnable</span> caller<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Store now for StatsLogging later.</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isRuntimeRestarted <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>
                <span class="token class-name">SystemProperties</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sys.boot_completed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/// 判断是64位还是32位？</span>
        <span class="token class-name">String</span> bootTimeTag <span class="token operator">=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">is64Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;Zygote64Timing&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Zygote32Timing&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">TimingsTraceLog</span> bootTimingsTraceLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimingsTraceLog</span><span class="token punctuation">(</span>bootTimeTag<span class="token punctuation">,</span>
                <span class="token class-name">Trace</span><span class="token punctuation">.</span>TRACE_TAG_DALVIK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">&quot;ZygoteInit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">preForkInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> startSystemServer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> zygoteSocketName <span class="token operator">=</span> <span class="token string">&quot;zygote&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> abiList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> enableLazyPreload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">/// 解析参数</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argv<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;start-system-server&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                startSystemServer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;--enable-lazy-preload&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                enableLazyPreload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>ABI_LIST_ARG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                abiList <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>ABI_LIST_ARG<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>SOCKET_NAME_ARG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                zygoteSocketName <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>SOCKET_NAME_ARG<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown command line argument: &quot;</span> <span class="token operator">+</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// Do an initial gc to clean up after startup</span>
        <span class="token comment">// 垃圾回收  GC 初始化</span>
        bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">&quot;PostZygoteInitGC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gcAndFinalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// PostZygoteInitGC</span>

        bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ZygoteInit</span>

        <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">initNativeState</span><span class="token punctuation">(</span>isPrimaryZygote<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ZygoteHooks</span><span class="token punctuation">.</span><span class="token function">stopZygoteNoThreadCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/// 创建一个Server 端</span>
        zygoteServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteServer</span><span class="token punctuation">(</span>isPrimaryZygote<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// fork 一个SystemServer进程</span>
            <span class="token class-name">Runnable</span> r <span class="token operator">=</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">,</span> zygoteSocketName<span class="token punctuation">,</span> zygoteServer<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// {@code r == null} in the parent (zygote) process, and {@code r != null} in the</span>
            <span class="token comment">// child (system_server) process.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Accepting command socket connections&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// The select loop returns early in the child process after a fork and</span>
        <span class="token comment">// loops forever in the zygote.</span>
        <span class="token comment">//循环等待fork出其他的应用进程，比如Launcher</span>
        <span class="token comment">//最终通过调用processOneCommand()来进行进程的处理</span>
        <span class="token comment">//监听socket消息，并且获取到java的函数入口，这里zygote会一直循环，能返回的都是fork出来的子进程</span>
        caller <span class="token operator">=</span> zygoteServer<span class="token punctuation">.</span><span class="token function">runSelectLoop</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;System zygote died with exception&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">//  返回的子进程并不需要父进程的zygoteServer，这东西对于它们来讲无用，所以在能返回的最后都要执行关闭zygoteServer</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>zygoteServer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// We're in the child process and have exited the select loop. Proceed to execute the</span>
    <span class="token comment">// command.        </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//执行返回的Runnable对象，进入子进程</span>
        caller<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>创建SystemServer进程</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span>
 <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span><span class="token class-name">String</span> abiList<span class="token punctuation">,</span> <span class="token class-name">String</span> socketName<span class="token punctuation">,</span>
            <span class="token class-name">ZygoteServer</span> zygoteServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">/* Hardcoded command line to start the system server */</span>
        <span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;--setuid=1000&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;--setgid=1000&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,&quot;</span>
                        <span class="token operator">+</span> <span class="token string">&quot;1024,1032,1065,3001,3002,3003,3006,3007,3009,3010,3011&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;--capabilities=&quot;</span> <span class="token operator">+</span> capabilities <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> capabilities<span class="token punctuation">,</span>
                <span class="token string">&quot;--nice-name=system_server&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;--runtime-args&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;--target-sdk-version=&quot;</span> <span class="token operator">+</span> <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span>SDK_VERSION_CUR_DEVELOPMENT<span class="token punctuation">,</span>
                <span class="token string">&quot;com.android.server.SystemServer&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">ZygoteArguments</span> parsedArgs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> pid<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// 调用native 方法fork新进程</span>
            <span class="token comment">/* Request to fork the system server process */</span>
            pid <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">forkSystemServer</span><span class="token punctuation">(</span>
                    parsedArgs<span class="token punctuation">.</span>mUid<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mGid<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mGids<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mRuntimeFlags<span class="token punctuation">,</span>
                    <span class="token keyword">null</span><span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mPermittedCapabilities<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mEffectiveCapabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* For child process */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasSecondZygote</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">waitForSecondaryZygote</span><span class="token punctuation">(</span>socketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果是子进程，需要将fork出来的父进程的zygoteServer关闭</span>
            zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">handleSystemServerProcess</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><ul><li>等待SystemServer的消息，创建其他进程,我们这里注意一下runSelectLoop 函数,该函数在接受到创建其他进程时，会走向 connection.processOneCommand() 方法</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</span>
<span class="token class-name">Runnable</span> <span class="token function">runSelectLoop</span><span class="token punctuation">(</span><span class="token class-name">String</span> abiList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pollReturnValue <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>pollIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pollFDs<span class="token punctuation">[</span>pollIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>pollIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Zygote server socket</span>

                    <span class="token class-name">ZygoteConnection</span> newPeer <span class="token operator">=</span> <span class="token function">acceptCommandPeer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    peers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    socketFDs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pollIndex <span class="token operator">&lt;</span> usapPoolEventFDIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Session socket accepted from the Zygote server socket</span>

                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">ZygoteConnection</span> connection <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pollIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//这个函数需要重点注意下</span>
                        <span class="token keyword">final</span> <span class="token class-name">Runnable</span> command <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">processOneCommand</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// TODO (chriswailes): Is this extra check necessary?</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsForkChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// We're in the child. We should always have a command to run at</span>
                            <span class="token comment">// this stage if processOneCommand hasn't called &quot;exec&quot;.</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;command == null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment">// 在此处进行了返回,主进程会一直卡在此函数，但子进程将会返回command，并且会执行command的run方法</span>
                            <span class="token keyword">return</span> command<span class="token punctuation">;</span> 
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Reset the child flag, in the event that the child process is a child-</span>
                        <span class="token comment">// zygote. The flag will not be consulted this loop pass after the</span>
                        <span class="token comment">// Runnable is returned.</span>
                        mIsForkChild <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>这里我们重点注意一下processOneCommand函数</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</span>
<span class="token class-name">Runnable</span> <span class="token function">processOneCommand</span><span class="token punctuation">(</span><span class="token class-name">ZygoteServer</span> zygoteServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">;</span>
        <span class="token comment">/// 读取传递过来的参数</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            args <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">readArgumentList</span><span class="token punctuation">(</span>mSocketReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;IOException on command socket&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//fork子进程,调用native方法</span>
        pid <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">forkAndSpecialize</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mUid<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mGid<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mGids<span class="token punctuation">,</span>
                parsedArgs<span class="token punctuation">.</span>mRuntimeFlags<span class="token punctuation">,</span> rlimits<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mMountExternal<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mSeInfo<span class="token punctuation">,</span>
                parsedArgs<span class="token punctuation">.</span>mNiceName<span class="token punctuation">,</span> fdsToClose<span class="token punctuation">,</span> fdsToIgnore<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mStartChildZygote<span class="token punctuation">,</span>
                parsedArgs<span class="token punctuation">.</span>mInstructionSet<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mAppDataDir<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mIsTopApp<span class="token punctuation">,</span>
                parsedArgs<span class="token punctuation">.</span>mPkgDataInfoList<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mWhitelistedDataInfoList<span class="token punctuation">,</span>
                parsedArgs<span class="token punctuation">.</span>mBindMountAppDataDirs<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mBindMountAppStorageDirs<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// in child</span>
                zygoteServer<span class="token punctuation">.</span><span class="token function">setForkChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">IoUtils</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>serverPipeFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                serverPipeFd <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token comment">// 子进程的初始化</span>
                <span class="token keyword">return</span> <span class="token function">handleChildProc</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">,</span> childPipeFd<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mStartChildZygote<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// In the parent. A pid &lt; 0 indicates a failure and will be handled in</span>
                <span class="token comment">// handleParentProc.</span>
                <span class="token class-name">IoUtils</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>childPipeFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                childPipeFd <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token function">handleParentProc</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> serverPipeFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">IoUtils</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>childPipeFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">IoUtils</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>serverPipeFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Runnable</span> <span class="token function">handleChildProc</span><span class="token punctuation">(</span><span class="token class-name">ZygoteArguments</span> parsedArgs<span class="token punctuation">,</span>
        <span class="token class-name">FileDescriptor</span> pipeFd<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isZygote<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
        * By the time we get here, the native code has closed the two actual Zygote
        * socket connections, and substituted /dev/null in their place.  The LocalSocket
        * objects still need to be closed properly.
        */</span>

    <span class="token function">closeSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">setAppProcessName</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">,</span> TAG<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// End of the postFork event.</span>
    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mInvokeWith <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">WrapperInit</span><span class="token punctuation">.</span><span class="token function">execApplication</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mInvokeWith<span class="token punctuation">,</span>
                parsedArgs<span class="token punctuation">.</span>mNiceName<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mTargetSdkVersion<span class="token punctuation">,</span>
                <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token function">getCurrentInstructionSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                pipeFd<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mRemainingArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Should not get here.</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;WrapperInit.execApplication unexpectedly returned&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isZygote<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/// zygoteInit 函数 ，初始化binder 线程池</span>
            <span class="token keyword">return</span> <span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span><span class="token function">zygoteInit</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mTargetSdkVersion<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mDisabledCompatChanges<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mRemainingArgs<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* classLoader */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span><span class="token function">childZygoteInit</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mTargetSdkVersion<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mRemainingArgs<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* classLoader */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>这里深入看一看返回的Runnable</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span>
 <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Runnable</span> <span class="token function">zygoteInit</span><span class="token punctuation">(</span><span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;RuntimeInit: Starting application from zygote&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">,</span> <span class="token string">&quot;ZygoteInit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">redirectLogStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">commonInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span><span class="token function">nativeZygoteInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">applicationInit</span><span class="token punctuation">(</span>targetSdkVersion<span class="token punctuation">,</span> disabledCompatChanges<span class="token punctuation">,</span> argv<span class="token punctuation">,</span>
            classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>这里会通过对应的信息去搜索 main 方法入口，返回的是MethodAndArgsCaller，该类是RuntimeInit的静态内部类，它的run 方法就是通过反射将参数args 传递进去，并运行这个函数，那么这个函数就是我们ActivityThread类的main方法入口,至此 Zygote 流程结束，接下来将会在ActivityThread 中进行进一步解析和讲解.</li> <li>如果对Java反射不清楚的读者请移步Java 反射相关文章</li> <li>如果对Socket通信不清楚的读者请移步Socket 通信相关文章</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</span>
 <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">applicationInit</span><span class="token punctuation">(</span><span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If the application calls System.exit(), terminate the process</span>
    <span class="token comment">// immediately without running any shutdown hooks.  It is not possible to</span>
    <span class="token comment">// shutdown an Android application gracefully.  Among other things, the</span>
    <span class="token comment">// Android runtime shutdown hooks close the Binder driver, which can cause</span>
    <span class="token comment">// leftover running threads to crash before the process actually exits.</span>
    <span class="token function">nativeSetExitWithoutCleanup</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTargetSdkVersion</span><span class="token punctuation">(</span>targetSdkVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDisabledCompatChanges</span><span class="token punctuation">(</span>disabledCompatChanges<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">Arguments</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Arguments</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// The end of of the RuntimeInit event (see #zygoteInit).</span>
    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Remaining arguments are passed to the start class's static main</span>
    <span class="token keyword">return</span> <span class="token function">findStaticMain</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>startClass<span class="token punctuation">,</span> args<span class="token punctuation">.</span>startArgs<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

 <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">findStaticMain</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span>
            <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cl<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        cl <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Missing class when invoking static main &quot;</span> <span class="token operator">+</span> className<span class="token punctuation">,</span>
                ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Method</span> m<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        m <span class="token operator">=</span> cl<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Missing static main on &quot;</span> <span class="token operator">+</span> className<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Problem getting static main on &quot;</span> <span class="token operator">+</span> className<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> modifiers <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Main method is not public and static on &quot;</span> <span class="token operator">+</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
        * This throw gets caught in ZygoteInit.main(), which responds
        * by invoking the exception's run() method. This arrangement
        * clears up all the stack frames that were required in setting
        * up the process.
        */</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MethodAndArgsCaller</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MethodAndArgsCaller</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token comment">/** method to call */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Method</span> mMethod<span class="token punctuation">;</span>

    <span class="token comment">/** argument array */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mArgs<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MethodAndArgsCaller</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mMethod <span class="token operator">=</span> method<span class="token punctuation">;</span>
        mArgs <span class="token operator">=</span> args<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 通过反射调用这个函数</span>
            mMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> mArgs <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Throwable</span> cause <span class="token operator">=</span> ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> cause<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">)</span> cause<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit" style="display:none;"><!----> <!----></footer> <!----> <!----> <!----></main> <!----></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-017cf06a><canvas id="canvas_sakura" style="z-index:20;" data-v-017cf06a></canvas></div><APlayer audio="" fixed="true" mini="true" autoplay="autoplay" theme="#b7daff" loop="loop" order="list" preload="auto" volume="0.7" mutex="true" lrc-type="3" list-max-height="250" storage-name="vuepress-plugin-meting" id="aplayer-fixed"></APlayer></div></div>
    <script src="/blog/assets/js/app.19518fa2.js" defer></script><script src="/blog/assets/js/5.4859d6c2.js" defer></script><script src="/blog/assets/js/1.5aece763.js" defer></script><script src="/blog/assets/js/29.c5bba8d3.js" defer></script>
  </body>
</html>
